--- 
layout: post
title: "tcpdump: go non-promiscuous"
mt_id: 22
---
Colleague of mine reminded me today, that <b>one does not want</b> tcpdump with the NIC in promiscuous mode (the default for tcpdump, turn it off with <tt>-p</tt>), when debugging problems. And really, there is no other use for tcpdump, than debugging problems. (You don't sniff for fun, do you? And I'd want to use Wireshark in that case anyway.)<br /><br />So, why is promiscuous mode a bad idea?<br />Because tcpdump will show you a very different truth - it will show you what's on the wire, but <b>not</b> what ethernet packets your machine really accepts under normal conditions - it will only accept packets which destination address is set to the machines ethernet address (plus some multicast stuff, but I'm usually not interested in those). This will especially get you in trouble, if you rely on the IP adresses in tcpdumps output to determine if "this packet is for me". You will fool yourself into thinking, "oh these packets all arrive here", and all your further conclusions from this point forward are <i>wrong</i>. <br /><br />Typical situation for this:<br /><ul><li>Machine M is connected to Router R</li><li>Machine M has got more than one IP address, but only the first one is directly bound to the interface</li><li>You swap the ethernet card in machine M (or migrate the whole machine to new hardware, probably more common these days)</li><li>IP connectivity works, but the secondary IPs are not reachable</li><ul><li>because router R caches the ethernet address for all IPs</li><li>only the primary/first IP got updated in the routers ARP cache (= IP address to ethernet address cache)<br /></li></ul><li>tcpdump will show you different truths:</li><ul><li>without ethernet address display turned on, plus NIC in promiscuous mode:</li><ul><li>shows that everything is fine</li></ul><li>NIC not in promiscous mode:</li><ul><li>would have shown you that the packets don't arrive ...<br /></li></ul></ul></ul>I failed to recognize this problem two times by now, first time this got us quite some outage time, and Yesterday I saw the symptoms, got the feeling that again the ARP cache is acting up, finally resolved the issue, but I hadn't proof that this was the problem. And I could have had... <i>if I'd used non-promisc mode or turned on ethernet address display in tcpdump.</i><br /><br />  
