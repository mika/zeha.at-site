--- 
layout: post
title: "Puppet: Exported Resources"
mt_id: 16
---
As of today we're using <a href="http://projects.puppetlabs.com/projects/puppet/wiki/Exported_Resources">Exported Resources</a> to let our <a href="http://munin.projects.linpro.no/">Munin</a> and <a href="http://www.bacula.org/">Bacula</a> servers know about their clients.<br /><br />It's really easy to set up. Enable <a href="http://projects.puppetlabs.com/projects/puppet/wiki/Using_Stored_Configuration">stored configuration</a> on the puppetmaster, create a resource the client exports and a place to collect them in the server config.<br /><br />Looks like this for the client node config:<br /><pre class="literal-block">  @@file { "/var/local/puppet/munin-nodes/$fqdn":<br />    &nbsp;content =&gt; "[$fqdn]\n other munin stuff here", <br />     tag =&gt; "munin",<br />  }</pre>And for the server node:<br /><pre class="literal-block">  File &lt;&lt;| tag == 'munin' |&gt;&gt;</pre><br />So, what does this do, really?<br /><ul><li>when puppet runs on the client node:</li><ul><li>encounter the @@file resource</li><li>save the encounter as well as the parameters to the storedconfigs db on the puppetmaster (in our case PostgreSQL of course).</li><li>that's it for the client node<br /></li></ul><li>when puppet runs on the server node:</li><ul><li>encounter the File &lt;&lt;||&gt;&gt; directive</li><li>query all the stored @@file encounters from the storedconfigs db</li><li>only those matching the specified tag will be used</li><li>realize all the matching files onto the server node</li><li>=&gt; lots of files in /var/local/puppet/munin-node/</li></ul></ul>Easy, huh.<br /><br />Note though, that the client node does not send a fully realized template back to puppetmaster, but will send the encounter of the @@file resource and the available $variables etc.<br />Also note that updates to the @@file resource will only become visible on the server node, after <b>both</b> the client node and the server node had a puppet run. (The exporting client node run must come before the server node run.)<br /><br />Setup notes for puppetmaster on Debian etch:<br /><ul><li>You probably already run puppet and puppetmaster from <a href="http://backports.debian.org/">backports.debian.org</a>.</li><li>That version requires the rails package from testing. It's not in bpo, so either fetch it from testing and directly install it or rebuild it yourself on etch (needs 2 or 3 other packages as well, <b>_if_</b> you rebuild it). Rebuilding was painless though.</li></ul>One more thing: if you want to manage the munin server, you'll have to use something like <a href="http://git.black.co.at/?p=module-common;a=blob;f=manifests/defines/concatenated_file.pp;hb=HEAD">concatenated_file</a> [from git.black.co.at] to generate munin.conf (as munin can't include a directory into it's configuration).<br /> 
