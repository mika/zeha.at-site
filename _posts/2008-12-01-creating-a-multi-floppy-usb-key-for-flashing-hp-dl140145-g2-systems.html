--- 
layout: post
title: Creating a multi-floppy USB Key (for flashing HP DL140/145 G2 systems)
mt_id: 27
---
I'm a (not-so) proud owner of one HP ProLiant DL140 G2 (Intel-based) and one HP ProLiant DL145 G2 (AMD-based) machines. These were, at the time, good machines, not so expensive, and had two fixed 3.5" SATA drives, allowing for cheap disk upgrades. (BTW, this blog runs on one of these.)<br /><br />HP had outfitted these machines with so-called "Lights-Out 100i management", basically delivering IPMI-based out-of-band management, with serial-over-LAN. If you take a look at what Supermicro delivers nowadays, you would not want the LO100i. I've also had lots of problems with the LO100i, so I stopped using it.<br /><br />Few days ago I decided to give the LO100i a new try. In the meantime, HP issued firmware upgrades for both the system ROMs as well as for the LO100i management processor (BMC). The journey begins...<br /><br />Interesting facts:<br /><ul><li>The DL140/145G2 were made in 2005, and were shipped without a floppy drive.</li><li>There is no way to add a floppy drive into the machine.</li><li>The EXE is a 16-bit DOS executable which runs in full-screen mode.</li><li>The downloaded EXE (containing the flash update) requires a floppy drive to write its self-contained floppy image to.</li><li>System ROM and BMC updates are seperate, so each one needs a seperate floppy disk.</li></ul><br />What's not working:<br /><ul><li>64bit Windows can <b>NOT</b> execute 16-bit DOS executables. All the Windows machines at work are 64bits. (They do not have a floppy drive anyway.)<br /></li><li>Full-screen DOS applications can <b>NOT</b> run inside a terminal services connection.</li><li>DOSEMU does crash on my 64bit Linux desktop.</li><li>Unzipping the downloaded EXE ("SoftPAQ") file does not work, it's some kind of Compaq propietary tool.</li></ul><br />Conclusions so far:<br /><ul><li>I've got one DL140 and one DL145, so I'd need 4 floppies.</li><li>I'd need a USB floppy drive. I checked at a local store, such a drive costs about 30 euros.</li><li>It would take lots of time in the data center.</li><li>I'd need even more than 4 floppies, because floppy disks are <u><i><b>very</b></i></u> unreliable.</li></ul><br />I decided to use a single USB key instead. I've been recently given such a (very cheap) key from my employer - nothing to lose if something goes wrong with it.<br /><br />Preparations:<br /><ul><li>Get a Windows desktop, install <a href="http://www.winimage.com/">WinImage</a></li><li>Get a Linux desktop with the following software:</li><ul><li>VirtualBox (Ubuntu: <tt>apt-get install virtualbox-ose</tt> and login again)</li><li>mkisofs</li><li>syslinux</li><li>The <a href="http://www.freedos.org/freedos/files/">FreeDOS</a> installation ISO. You'll only need the small base-cd ISO.</li></ul><li>Download the relevant updates from hp.com. For me those were:<br /></li><ul><li>DL140G2 BIOS: SP32670.EXE</li><li>DL140G2 BMC: SP33955.EXE<br />
</li><li>DL145G2 BIOS: SP33884.EXE</li><li>DL145G2 BMC: SP33956.EXE</li></ul></ul><br />
  
Now lets do this:<br /><br />1) Use WinImage to create an empty image of a 1.44MB floppy disk. Save it as floppy.img (select <b>uncompressed</b> before saving it). floppy.img will serve as a virtual floppy disk for the SoftPAQs. <br /><br />2) Copy floppy.img to your Linux desktop, put the Windows machine aside.<br />Yes, you could use dd + mtools/mformat to do this, but it's so much easier with WinImage.<br /><br />3) Create a ISO from the updates. <tt>mkdir temp_dir</tt>, copy all the EXEs into it; run:<pre>mkisofs -o updates.iso temp_dir
</pre>This updates.iso will serve as the source for our DOS VM, so we don't have to set up networking inside the VM.<br /><br />4) Start VirtualBox, create a new VM, profile type DOS. Create a virtual hard drive for it.<br /><br />5) Add the floppy.img and the FreeDOS ISO to your newly created VirtualBOX VM.<br /><br />6) Boot the VM, install FreeDOS to the virtual hard drive. Follow the on-screen instructions; xfdisk hanged for me at reboot time, resetting the VM worked fine.<br /><br />7) Mount updates.iso in VirtualBox instead of the FreeDOS ISO.<br /><br />8) Inside FreeDOS: mkdir c:\tmp ; copy all files from the virtual CD drive (usually D:) to c:\tmp (the ROMpaq stuff won't work properly from the virtual CD drive).<br /><br />9) For every single update:<br />9a) <tt>format a:</tt>&nbsp; (without this, the extractor will fail to recognize the floppy disk after the first run)<br />9b) run the <tt>SPxxxx.exe</tt>, type Agree and have it write the update to drive A:<br />9c) unmount the floppy.img from VirtualBox, save it away with a meaningful filename. We'll put these images onto the USB key later on.<br />9d) re-mount floppy.img in VirtualBox<br /><br />10) Shut down VirtualBox. Save your VM for the future.<br /><br />11) Prepare the USB key. If there's something on it, make a backup - we'll wipe it in the next step.<br /><br />12) Write a superfloppy-style DOS filesystem onto the USB key. This will allow most BIOSes to boot from the key. Run:<br /><pre>mkdosfs -I /dev/sdX
</pre><br />13) Put the syslinux bootloader onto it:<br /><pre>syslinux /dev/sdX
</pre><br />14) Mount the new filesystem on your USB key, so we can copy more stuff onto it:<pre>mount /dev/sdX /mnt
</pre><br />15) Copy the floppy images you created above to /mnt. Remember that you can't use long filenames (so 8.3 filenames must do; directories are okay).<br /><br />16) Create /mnt/syslinux.cfg. This is the configuration file for the bootloader. We'll want syslinux to stop after loading and issue a prompt:<br /><pre>echo "PROMPT 1" &gt;/mnt/syslinux.cfg
</pre>
<br />17) Copy the memdisk kernel. It's a floppy emulator (for A:), which operates in RAM.<br /><pre>cp /usr/lib/syslinux/memdisk /mnt/</pre>
<br />18) For every floppy image you have, put the following lines into your syslinux.cfg. They will tell syslinux what to do with all the files:<br /><pre>    label IDENTIFIER
        kernel memdisk
        append initrd=FLOPPYIMAGE.NAME
<br /></pre>
Obviously, you need to replace FLOPPYIMAGE.NAME and IDENTIFIER. IDENTIFIER will be the string you type at the syslinux prompt after booting from the USB key, to select this particular floppy image.<br /><br />19) <code>umount /mnt</code> and try your fresh 4floppy-in-1key.<br /><br /><br /> 
